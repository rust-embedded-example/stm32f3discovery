<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>完善工程 - rust embedded example book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rust embedded example book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="完善工程"><a class="header" href="#完善工程">完善工程</a></h1>
<p>在<a href="./%E5%88%9B%E5%BB%BAPAC%E5%BA%93.html">上一章</a>中，创建了<code>stm32f303 crate</code>，这一章将这个<code>crate</code>引入pac工程。</p>
<h2 id="添加编译设置"><a class="header" href="#添加编译设置">添加编译设置</a></h2>
<p>在根目录下创建<code>.cargo/config.toml</code>，内容为:</p>
<pre><code class="language-toml">[target.thumbv7em-none-eabihf]
rustflags = ["-C", "link-arg=-Tlink.x"]

[build]
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)
</code></pre>
<h2 id="cargoconfigtoml配置解释"><a class="header" href="#cargoconfigtoml配置解释">.cargo/config.toml配置解释</a></h2>
<p>这个配置文件是Cargo的项目级配置，用于设置特定于该项目的构建参数。它会影响所有在该项目目录下执行的<code>cargo</code>命令。</p>
<h3 id="1-目标平台特定配置"><a class="header" href="#1-目标平台特定配置">1. 目标平台特定配置</a></h3>
<pre><code class="language-toml">[target.thumbv7em-none-eabihf]
rustflags = ["-C", "link-arg=-Tlink.x"]
</code></pre>
<p><strong><code>[target.thumbv7em-none-eabihf]</code></strong></p>
<ul>
<li>为特定目标平台（thumbv7em-none-eabihf）设置编译选项</li>
<li>这个目标对应ARM Cortex-M4F和Cortex-M7F微控制器</li>
<li>只有在编译到这个目标时，这些设置才会生效</li>
</ul>
<p><strong><code>rustflags = ["-C", "link-arg=-Tlink.x"]</code></strong></p>
<ul>
<li>向Rust编译器传递额外的编译标志</li>
<li><code>-C</code>：告诉rustc这是一个编译器选项</li>
<li><code>link-arg=-Tlink.x</code>：向链接器传递参数
<ul>
<li><code>-T</code>：指定链接脚本（linker script）</li>
<li><code>link.x</code>：链接脚本文件名，由<code>cortex-m-rt</code> crate提供</li>
<li>这个脚本定义了内存布局、启动代码位置、中断向量表等关键信息</li>
</ul>
</li>
</ul>
<h3 id="2-默认构建目标"><a class="header" href="#2-默认构建目标">2. 默认构建目标</a></h3>
<pre><code class="language-toml">[build]
target = "thumbv7em-none-eabihf" # Cortex-M4F and Cortex-M7F (with FPU)
</code></pre>
<p><strong><code>target = "thumbv7em-none-eabihf"</code></strong></p>
<ul>
<li>设置项目的默认编译目标</li>
<li>无需每次运行<code>cargo build</code>时手动指定<code>--target</code>参数</li>
<li>自动为STM32F303等Cortex-M4F微控制器进行交叉编译</li>
</ul>
<p><strong>注释说明</strong></p>
<ul>
<li><code>Cortex-M4F and Cortex-M7F (with FPU)</code>：明确这个目标适用于带浮点单元的Cortex-M4F和M7F</li>
<li>STM32F303使用的是Cortex-M4F内核，完全匹配这个目标</li>
</ul>
<h2 id="配置文件的作用"><a class="header" href="#配置文件的作用">配置文件的作用</a></h2>
<h3 id="1-简化构建流程"><a class="header" href="#1-简化构建流程">1. <strong>简化构建流程</strong></a></h3>
<ul>
<li>无需每次手动指定目标平台</li>
<li>自动应用正确的链接参数</li>
<li>提供一致的构建环境</li>
</ul>
<h3 id="2-链接脚本管理"><a class="header" href="#2-链接脚本管理">2. <strong>链接脚本管理</strong></a></h3>
<ul>
<li><code>link.x</code>由<code>cortex-m-rt</code>提供，包含：
<ul>
<li>内存区域定义（FLASH、RAM地址和大小）</li>
<li>启动代码入口点</li>
<li>中断向量表布局</li>
<li>栈指针初始化</li>
</ul>
</li>
</ul>
<h3 id="3-项目标准化"><a class="header" href="#3-项目标准化">3. <strong>项目标准化</strong></a></h3>
<ul>
<li>确保团队成员使用相同的构建配置</li>
<li>避免因构建参数不同导致的问题</li>
<li>提供可重现的构建结果</li>
</ul>
<h2 id="为什么需要这些配置"><a class="header" href="#为什么需要这些配置">为什么需要这些配置？</a></h2>
<h3 id="嵌入式特殊需求"><a class="header" href="#嵌入式特殊需求">嵌入式特殊需求</a></h3>
<ol>
<li><strong>内存布局控制</strong>：嵌入式设备有特定的内存映射，需要链接脚本精确定义</li>
<li><strong>启动代码</strong>：微控制器需要特殊的启动序列，不同于普通程序</li>
<li><strong>交叉编译</strong>：在PC上编译，在ARM微控制器上运行</li>
<li><strong>资源限制</strong>：必须精确控制代码和数据在内存中的位置</li>
</ol>
<h3 id="配置优势"><a class="header" href="#配置优势">配置优势</a></h3>
<ul>
<li><strong>自动化</strong>：减少手动操作，避免错误</li>
<li><strong>一致性</strong>：确保所有构建使用相同参数</li>
<li><strong>便利性</strong>：简化日常开发工作流程</li>
</ul>
<p>这个配置文件是嵌入式Rust项目的标准组成部分，为正确的交叉编译和链接提供了必要的设置。</p>
<h2 id="修改cargotoml"><a class="header" href="#修改cargotoml">修改<code>./Cargo.toml</code></a></h2>
<p>在<code>[dependencies]</code>中添加<code>stm32f303pac</code>依赖，修改后的<code>./Cargo.toml</code>如下:</p>
<pre><code class="language-toml">[package]
name = "pac"
version = "0.1.0"
edition = "2024"

[dependencies]
cortex-m = { version = "0.7.7", features = ["critical-section-single-core"] }
cortex-m-rt = "0.7.5"
rtt-target = "0.6.1"
panic-rtt-target = "0.1.3"
stm32f303pac = { path = "./stm32f303pac", features = ["critical-section"] }

[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
</code></pre>
<h2 id="添加memoryx文件"><a class="header" href="#添加memoryx文件">添加<code>memory.x</code>文件</a></h2>
<p>在<code>./.cargo/config.toml</code>文件中指定了<code>link.x</code>链接脚本，这个脚本由<code>cortex-m-rt</code> crate生成，并引用<code>memory.x</code>，因此我们需要提供一个<code>memory.x</code>文件。创建<code>./memory.x</code>，内容为:</p>
<pre><code class="language-text">/* Linker script for the STM32F303VCT6 */
MEMORY
{
  /* NOTE 1 K = 1 KiBi = 1024 bytes */
  FLASH : ORIGIN = 0x08000000, LENGTH = 256K
  RAM : ORIGIN = 0x20000000, LENGTH = 40K
}
</code></pre>
<h2 id="添加工程例子代码"><a class="header" href="#添加工程例子代码">添加工程例子代码</a></h2>
<p>完成了前面的内容后，工程可以编译了，但不可运行。程序没有初始化硬件。</p>
<p>修改<code>./src/main.rs</code>如下:</p>
<pre><pre class="playground"><code class="language-rust">#![no_main]
#![no_std]

use cortex_m_rt::entry;
use panic_rtt_target as _;
use rtt_target::{rprintln, rtt_init_print};
use stm32f303pac as pac;

// 简单的延时函数
fn delay(cycles: u32) {
    for _ in 0..cycles {
        cortex_m::asm::nop(); // 执行空操作来消耗CPU周期
    }
}

#[entry]
fn main() -&gt; ! {
    // 初始化RTT打印
    rtt_init_print!();
    rprintln!("Starting simple LED blink program");

    // 获取外设访问
    let dp = pac::Peripherals::take().unwrap();

    // 启用GPIOE时钟
    let rcc = &amp;dp.rcc;
    rcc.ahbenr().modify(|_, w| w.iopeen().set_bit());

    // 配置PE8为推挽输出模式
    let gpioe = &amp;dp.gpioe;
    gpioe
        .moder()
        .modify(|_, w| unsafe { w.moder8().bits(0b01) }); // 设置为输出模式
    gpioe.otyper().modify(|_, w| w.ot8().clear_bit()); // 推挽输出

    rprintln!("LED blink initialized on PE8");

    // 主循环，周期性切换LED状态
    loop {
        // 打开LED (设置高电平)
        gpioe.bsrr().write(|w| w.bs8().set_bit());
        rprintln!("LED ON");
        delay(1_000_000); // 延时

        // 关闭LED (设置低电平)
        gpioe.bsrr().write(|w| w.br8().set_bit());
        rprintln!("LED OFF");
        delay(1_000_000); // 延时
    }
}
</code></pre></pre>
<p>将<code>STM32F3DISCOVERY</code>接入电脑。使用<code>lsusb</code>命令可查看是否识别到了`ST-LINK。</p>
<p>运行:</p>
<pre><code class="language-bash">cargo build
cargo flash --release --chip STM32F303VCTx
</code></pre>
<p>即可烧录成功。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../PAC/创建PAC库.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../PAC/调试.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../PAC/创建PAC库.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../PAC/调试.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
