<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>创建基础工程 - rust embedded example book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rust embedded example book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="创建基础工程"><a class="header" href="#创建基础工程">创建基础工程</a></h1>
<p>使用命令创建一个基本的工程：</p>
<pre><code class="language-bash">cargo new pac
cd pac
cargo run
</code></pre>
<p>将输出:</p>
<pre><code class="language-bash">   Compiling pac v0.1.0 (/home/a/workspace/embedded/stm32f3discovery/pac)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.06s
     Running `target/debug/pac`
Hello, world!
</code></pre>
<p>说明基本工程建立完成。本章后续所有路径均以pac文件夹为根目录，即<code>main.rs</code>所在路径表示为<code>./src/main,rs</code></p>
<h1 id="no_std"><a class="header" href="#no_std">no_std</a></h1>
<p>我们制作的工程是运行在裸机环境中的，因此不支持<code>std</code>库，更多信息请阅读 <a href="https://docs.rust-embedded.org/book/intro/no-std.html">rust embedded book</a>。</p>
<h1 id="修改mainrs"><a class="header" href="#修改mainrs">修改<code>main.rs</code></a></h1>
<pre><code class="language-rust ignore">#![no_main]
#![no_std]

use cortex_m_rt::entry;
use panic_rtt_target as _;
use rtt_target::{rprintln, rtt_init_print};

#[entry]
fn main() -&gt; ! {
    rtt_init_print!();
    rprintln!("Hello, world!");

    loop {}
}</code></pre>
<h2 id="代码逐行解释"><a class="header" href="#代码逐行解释">代码逐行解释</a></h2>
<h3 id="1-属性声明"><a class="header" href="#1-属性声明">1. 属性声明</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>#![no_main]
#![no_std]
<span class="boring">fn main() {
</span><span class="boring">}</span></code></pre></pre>
<p><strong><code>#![no_main]</code></strong></p>
<ul>
<li>告诉Rust编译器不要使用标准的<code>main</code>函数作为程序入口点</li>
<li>在嵌入式系统中，我们需要自定义入口点来初始化硬件</li>
<li>这是因为嵌入式设备的启动过程与普通桌面程序不同</li>
</ul>
<p><strong><code>#![no_std]</code></strong></p>
<ul>
<li>禁用Rust标准库（std）</li>
<li>因为嵌入式设备没有操作系统，无法使用依赖操作系统的标准库功能</li>
<li>只使用<code>core</code>库，这是Rust的核心功能，不依赖操作系统</li>
<li>这样可以大大减小程序的体积和内存占用</li>
</ul>
<h3 id="2-导入依赖"><a class="header" href="#2-导入依赖">2. 导入依赖</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use cortex_m_rt::entry;
use panic_rtt_target as _;
use rtt_target::{rprintln, rtt_init_print};
<span class="boring">}</span></code></pre></pre>
<p><strong><code>use cortex_m_rt::entry;</code></strong></p>
<ul>
<li><code>cortex_m_rt</code>是ARM Cortex-M微控制器的运行时库</li>
<li><code>entry</code>宏定义了程序的入口点，替代标准的<code>main</code>函数</li>
<li>它会生成必要的启动代码和中断向量表</li>
</ul>
<p><strong><code>use panic_rtt_target as _;</code></strong></p>
<ul>
<li>导入panic处理程序，使用RTT（Real-Time Transfer）输出panic信息</li>
<li><code>as _</code>表示导入但不直接使用变量名，只是为了让编译器知道这个模块存在</li>
<li>当程序发生panic时，错误信息会通过RTT输出到调试器</li>
</ul>
<p><strong><code>use rtt_target::{rprintln, rtt_init_print};</code></strong></p>
<ul>
<li><code>rtt_target</code>是RTT通信库，用于与调试器进行实时通信</li>
<li><code>rprintln!</code>：类似标准库的<code>println!</code>，但输出到RTT通道而不是标准输出</li>
<li><code>rtt_init_print!</code>：初始化RTT打印功能的宏</li>
</ul>
<h3 id="3-主函数定义"><a class="header" href="#3-主函数定义">3. 主函数定义</a></h3>
<pre><pre class="playground"><code class="language-rust">#[entry]
fn main() -&gt; ! {</code></pre></pre>
<p><strong><code>#[entry]</code></strong></p>
<ul>
<li>这是一个属性宏，标记这个函数为程序的真正入口点</li>
<li>编译器会生成必要的启动代码，包括栈指针初始化、静态变量初始化等</li>
<li>替代了标准的<code>main</code>函数</li>
</ul>
<p><strong><code>fn main() -&gt; !</code></strong></p>
<ul>
<li>函数返回类型<code>!</code>表示"永不返回"（never类型）</li>
<li>在嵌入式系统中，主函数通常是一个无限循环，永远不会正常退出</li>
<li>这确保了程序会持续运行，直到设备断电或重置</li>
</ul>
<h3 id="4-函数体"><a class="header" href="#4-函数体">4. 函数体</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    rtt_init_print!();
    rprintln!("Hello, world!");

    loop {}
<span class="boring">}</span></code></pre></pre>
<p><strong><code>rtt_init_print!();</code></strong></p>
<ul>
<li>初始化RTT打印系统</li>
<li>设置与调试器的通信通道</li>
<li>必须在使用<code>rprintln!</code>之前调用</li>
</ul>
<p><strong><code>rprintln!("Hello, world!");</code></strong></p>
<ul>
<li>通过RTT输出"Hello, world!"消息</li>
<li>这个消息会显示在调试器的控制台中（如probe-rs、OpenOCD等）</li>
<li>语法与标准的<code>println!</code>相同，但输出目标不同</li>
</ul>
<p><strong><code>loop {}</code></strong></p>
<ul>
<li>无限循环，防止程序退出</li>
<li>在嵌入式系统中，程序应该持续运行</li>
<li>如果没有这个循环，程序会尝试返回，但由于返回类型是<code>!</code>，会导致编译错误</li>
</ul>
<h2 id="整体功能说明"><a class="header" href="#整体功能说明">整体功能说明</a></h2>
<p>这段代码实现了一个最基本的嵌入式"Hello World"程序：</p>
<ol>
<li><strong>初始化阶段</strong>：设置RTT通信通道</li>
<li><strong>输出阶段</strong>：打印欢迎消息</li>
<li><strong>运行阶段</strong>：进入无限循环保持程序运行</li>
</ol>
<p>这是学习Rust嵌入式开发的第一步，为后续的硬件操作和更复杂的功能打下基础。</p>
<h1 id="修改cargotoml"><a class="header" href="#修改cargotoml">修改<code>Cargo.toml</code></a></h1>
<pre><code class="language-toml">name = "pac"
version = "0.1.0"
edition = "2024"

[dependencies]
cortex-m = { version = "0.7.7", features = ["critical-section-single-core"] }
cortex-m-rt = "0.7.5"
rtt-target = "0.6.1"
panic-rtt-target = "0.1.3"

[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
</code></pre>
<h2 id="cargotoml配置解释"><a class="header" href="#cargotoml配置解释">Cargo.toml配置解释</a></h2>
<h3 id="1-项目基本信息"><a class="header" href="#1-项目基本信息">1. 项目基本信息</a></h3>
<pre><code class="language-toml">name = "pac"
version = "0.1.0"
edition = "2024"
</code></pre>
<p><strong><code>name = "pac"</code></strong></p>
<ul>
<li>定义项目名称为"pac"</li>
<li>这个名称会用作生成的二进制文件名</li>
<li>对应我们创建的PAC（Peripheral Access Crate）项目</li>
</ul>
<p><strong><code>version = "0.1.0"</code></strong></p>
<ul>
<li>项目版本号，遵循语义化版本控制（Semantic Versioning）</li>
<li>格式为：主版本号.次版本号.修订号</li>
</ul>
<p><strong><code>edition = "2024"</code></strong></p>
<ul>
<li>指定使用Rust 2024版本</li>
<li>Rust版本决定了可用的语言特性和默认行为</li>
<li>2024版本包含了最新的语言改进和特性</li>
</ul>
<h3 id="2-依赖库配置"><a class="header" href="#2-依赖库配置">2. 依赖库配置</a></h3>
<pre><code class="language-toml">[dependencies]
cortex-m = { version = "0.7.7", features = ["critical-section-single-core"] }
cortex-m-rt = "0.7.5"
rtt-target = "0.6.1"
panic-rtt-target = "0.1.3"
</code></pre>
<p><strong><code>cortex-m = { version = "0.7.7", features = ["critical-section-single-core"] }</code></strong></p>
<ul>
<li>ARM Cortex-M微控制器的底层访问库</li>
<li>提供对Cortex-M特定功能的访问，如NVIC（中断控制器）、系统控制寄存器等</li>
<li><code>features = ["critical-section-single-core"]</code>：启用单核临界区功能，用于在中断处理中保护共享数据</li>
</ul>
<p><strong><code>cortex-m-rt = "0.7.5"</code></strong></p>
<ul>
<li>Cortex-M运行时库</li>
<li>提供启动代码、中断向量表、内存布局等</li>
<li>包含<code>#[entry]</code>宏的实现</li>
</ul>
<p><strong><code>rtt-target = "0.6.1"</code></strong></p>
<ul>
<li>RTT（Real-Time Transfer）通信库</li>
<li>实现与调试器的实时数据传输</li>
<li>提供<code>rprintln!</code>等打印宏</li>
</ul>
<p><strong><code>panic-rtt-target = "0.1.3"</code></strong></p>
<ul>
<li>RTT panic处理器</li>
<li>当程序发生panic时，通过RTT输出错误信息到调试器</li>
<li>替代标准的panic处理机制</li>
</ul>
<h3 id="3-编译配置文件"><a class="header" href="#3-编译配置文件">3. 编译配置文件</a></h3>
<pre><code class="language-toml">[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
</code></pre>
<p><strong><code>[profile.dev]</code> 和 <code>[profile.release]</code></strong></p>
<ul>
<li>分别配置开发模式和发布模式的编译选项</li>
<li><code>dev</code>：用于开发和调试，通常编译速度快但优化程度低</li>
<li><code>release</code>：用于最终发布，编译时间长但代码高度优化</li>
</ul>
<p><strong><code>panic = "abort"</code></strong></p>
<ul>
<li>设置panic行为为"abort"（中止）而不是"unwind"（展开）</li>
<li>在嵌入式系统中，通常选择abort因为：
<ul>
<li><strong>节省空间</strong>：不需要包含展开代码，减小二进制文件大小</li>
<li><strong>简化处理</strong>：直接终止程序，不进行复杂的栈展开</li>
<li><strong>确定性行为</strong>：在资源受限的环境中提供可预测的行为</li>
</ul>
</li>
</ul>
<h2 id="为什么需要这些配置"><a class="header" href="#为什么需要这些配置">为什么需要这些配置？</a></h2>
<h3 id="嵌入式特殊需求"><a class="header" href="#嵌入式特殊需求">嵌入式特殊需求</a></h3>
<ol>
<li><strong>资源限制</strong>：嵌入式设备内存和存储空间有限，需要精简的依赖</li>
<li><strong>实时性</strong>：需要确定性的行为，避免复杂的运行时机制</li>
<li><strong>调试困难</strong>：没有标准输出，需要特殊的调试通信方式（RTT）</li>
<li><strong>硬件相关</strong>：需要直接访问硬件寄存器和中断系统</li>
</ol>
<h3 id="依赖选择原因"><a class="header" href="#依赖选择原因">依赖选择原因</a></h3>
<ul>
<li><strong>cortex-m系列</strong>：提供ARM Cortex-M架构的底层支持</li>
<li><strong>rtt系列</strong>：解决嵌入式调试输出问题</li>
<li><strong>panic配置</strong>：优化资源使用，提供确定性行为</li>
</ul>
<p>这个配置为嵌入式Rust开发提供了完整的基础环境。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../PAC/PAC.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../PAC/创建PAC库.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../PAC/PAC.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../PAC/创建PAC库.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
